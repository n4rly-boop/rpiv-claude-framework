---
description: Extract code conventions, patterns, architecture, and dependencies from codebase
model: opus
---

# Extract Conventions

You are tasked with analyzing a codebase to extract and document all conventions, patterns, architecture decisions, and dependencies. This creates a persistent knowledge base for consistent development.

## Output Location

Use the `obsidian` MCP server to save artifacts. Determine repo name with: `basename $(git rev-parse --show-toplevel)`

All extracted documentation goes to `{repo_name}/claude/knowledge/`:
```
{repo_name}/claude/knowledge/
├── conventions/
│   └── main.md         # Code style, naming, file structure
├── patterns/
│   └── main.md         # Common implementation patterns
├── architecture.md     # Service boundaries, data flow, infrastructure
└── dependencies.md     # Inter-repo deps, shared libs, external services
```

## Important: Context Compression

- Use distiller agents for deep analysis
- Write all docs to vault via MCP
- Return only paths + brief summary (max 10 lines)
- **NEVER paste full convention docs into chat**

## Process

### Phase 1: Initial Scan

1. **Identify repository type and stack**:
   - Language(s) and frameworks
   - Build system (maven, gradle, npm, etc.)
   - Package manager and dependency files
   - CI/CD configuration

2. **Find existing documentation**:
   - README files at all levels
   - CONTRIBUTING.md, STYLE_GUIDE.md, etc.
   - ADRs (Architecture Decision Records)
   - OpenAPI/Swagger specs
   - Proto files, GraphQL schemas

3. **Scan configuration files**:
   - Linter configs (.eslintrc, .pylintrc, checkstyle.xml, etc.)
   - Formatter configs (prettier, black, spotless, etc.)
   - Editor configs (.editorconfig)
   - TypeScript/compiler configs

### Phase 2: Deep Analysis (Parallel Sub-Agents)

Spawn these sub-agents in parallel:

**Agent 1: Code Style Analysis**
```
Analyze code style and naming conventions:
- Variable/function/class naming patterns
- File and directory naming conventions
- Import organization and grouping
- Comment styles and documentation patterns
- Error handling patterns
- Logging conventions
Extract 3-5 concrete examples for each pattern found.
```

**Agent 2: Architecture Analysis**
```
Analyze architecture and structure:
- Project structure and module organization
- Layer separation (controllers, services, repositories, etc.)
- Dependency injection patterns
- Configuration management
- Environment handling
- Service boundaries and responsibilities
Map the high-level architecture with component relationships.
```

**Agent 3: Pattern Analysis**
```
Find common implementation patterns:
- API endpoint patterns (REST conventions, error responses)
- Database access patterns (repositories, DAOs, ORMs)
- Authentication/authorization patterns
- Caching strategies
- Async/messaging patterns
- Testing patterns (unit, integration, e2e structure)
Extract reusable code snippets as templates.
```

**Agent 4: Dependency Analysis**
```
Analyze dependencies and integrations:
- Internal shared libraries (versions, purposes)
- External service integrations (APIs, databases, queues)
- Inter-repository dependencies
- Deployment dependencies (infrastructure, secrets)
- Version constraints and compatibility
Create dependency map with version requirements.
```

### Phase 3: Synthesis

1. **Consolidate findings** from all agents
2. **Resolve conflicts** - if patterns vary, document the variations with context
3. **Identify gaps** - missing conventions that should be established
4. **Create actionable guidelines** - not just descriptions, but "do this, not that"

### Phase 4: Write Documentation

Use `obsidian` MCP to create/update each file in `{repo_name}/claude/knowledge/`:

#### conventions.md Structure:
```markdown
# Code Conventions

> Auto-generated by /extract_conventions on YYYY-MM-DD
> Source: [repo-name]

## Language & Stack
- Primary: [language] [version]
- Framework: [framework] [version]
- Build: [build-system]

## Naming Conventions

### Files & Directories
| Type | Convention | Example |
|------|------------|---------|
| Components | PascalCase | `UserProfile.tsx` |
| Utils | camelCase | `formatDate.ts` |
| ... | ... | ... |

### Code
| Type | Convention | Example |
|------|------------|---------|
| Classes | PascalCase | `OrderService` |
| Methods | camelCase | `calculateTotal()` |
| Constants | SCREAMING_SNAKE | `MAX_RETRY_COUNT` |
| ... | ... | ... |

## Code Style

### Imports
[Order and grouping rules with example]

### Error Handling
[Pattern with example]

### Logging
[Format and levels with example]

## DO / DON'T Quick Reference
| DO | DON'T |
|----|-------|
| Use `Optional<T>` for nullable returns | Return null directly |
| ... | ... |
```

#### patterns.md Structure:
```markdown
# Implementation Patterns

> Auto-generated by /extract_conventions on YYYY-MM-DD

## API Patterns

### REST Endpoint Template
\`\`\`[language]
[actual code from codebase as template]
\`\`\`

### Error Response Format
\`\`\`json
{
  "error": "string",
  "code": "string",
  "details": {}
}
\`\`\`

## Data Access Patterns
[Repository/DAO patterns with examples]

## Testing Patterns
[Unit test structure, mocking conventions]

## Common Utilities
[List of shared utilities and when to use them]
```

#### architecture.md Structure:
```markdown
# Architecture

> Auto-generated by /extract_conventions on YYYY-MM-DD

## System Overview
[ASCII diagram or description of major components]

## Module Structure
```
src/
├── api/          # HTTP handlers
├── domain/       # Business logic
├── infra/        # External integrations
└── shared/       # Cross-cutting concerns
```

## Data Flow
[Request lifecycle, data transformation points]

## Service Boundaries
[What each service/module owns]

## Configuration
[How config is loaded, environment handling]
```

#### dependencies.md Structure:
```markdown
# Dependencies

> Auto-generated by /extract_conventions on YYYY-MM-DD

## Internal Dependencies
| Library | Version | Purpose | Owner Repo |
|---------|---------|---------|------------|
| common-utils | 2.3.x | Shared utilities | platform/common |
| ... | ... | ... | ... |

## External Services
| Service | Purpose | Config Key | Docs |
|---------|---------|------------|------|
| PostgreSQL | Primary DB | DATABASE_URL | [link] |
| Redis | Caching | REDIS_URL | [link] |
| ... | ... | ... | ... |

## Inter-Repo Dependencies
[Which repos depend on this, which this depends on]

## Version Constraints
[Compatibility notes, upgrade considerations]
```

## Incremental Updates

If `{repo_name}/claude/knowledge/` already exists in vault:
1. Read existing documentation first
2. Compare with current analysis
3. Highlight what changed (new patterns, deprecated patterns)
4. Update files preserving manual additions marked with `<!-- manual -->` comments

## Final Output

After writing all files, provide a summary:
```
## Extraction Complete

Created/Updated:
- {repo_name}/claude/knowledge/conventions/main.md
- {repo_name}/claude/knowledge/patterns/main.md
- {repo_name}/claude/knowledge/architecture.md
- {repo_name}/claude/knowledge/dependencies.md

Key Findings:
- [Notable pattern or convention]
- [Potential inconsistency found]

Next: /rpiv_start to begin implementation with these conventions
```

**IMPORTANT**: Do NOT paste convention contents into chat. Return only paths and brief summary.
